---
export const prerender = false;

import Layout from '../../../../layouts/Layout.astro';
import { getProjects, getProjectById } from '../../../../lib/api';
import i18n from '../../../../i18n/i18n';

import ExternalLinksSection from '@/components/projectDetail/ExternalLinksSection.astro';
import ContentSection from '@/components/projectDetail/ContentSection.astro';
import HeroSection from '@/components/projectDetail/HeroSection.astro';
import ContributorSection from '@/components/projectDetail/ContributorSection.astro';
import CertifySection from '@/components/projectDetail/CertifySection.astro';
import CommentSection from '@/components/projectDetail/CommentSection.astro';
import RelatedProjectSection from '@/components/projectDetail/RelatedProjectSection.astro';
import HeaderBar from '@/components/common/header/HeaderBar.astro';

// empty user context, will be filled on client
const userContext = {
  userId: null,
  username: null,
  name: null,
  avatar: null,
  role: null,
  email: null,
  isAuthenticated: false,
  isProfessor: false,
};

// generate paths
export async function getStaticPaths() {
  const projects = await getProjects();
  const languages = ['en', 'th'];
  const paths = projects.data.flatMap((p) => {
    return languages.map((lang) => {
      return {
        params: {
          lang,
          slug: p.projectId,
        },
      };
    });
  });
  return paths;
}

// load params and project
const { slug: projectId, lang } = Astro.params as {
  slug: string;
  lang: string;
};
const currentLang = lang === 'th' ? 'th' : 'en';
i18n.changeLanguage(currentLang);
const t = i18n.t.bind(i18n);

const { data: sessionData } = await Astro.locals.supabase.auth.getSession(); 
const token = sessionData.session?.access_token;

const project = await getProjectById(projectId, token);
if (!project) {
  return Astro.redirect(`/${currentLang}/404`, 302);
}
---

<Layout title={project.title}>
  <HeaderBar t={t} lang={lang} />
  <HeroSection t={t} lang={lang} project={project} token={token} userContext={userContext}/>
  <ContentSection t={t} lang={lang} project={project} />
  <ExternalLinksSection t={t} lang={lang} project={project} />
  <ContributorSection t={t} lang={lang} project={project} />
  <CertifySection t={t} lang={lang} project={project}/>
  <CommentSection t={t} lang={lang} project={project} token={token} userContext={userContext}/>
  <RelatedProjectSection t={t} lang={lang} project={project} />
</Layout>
