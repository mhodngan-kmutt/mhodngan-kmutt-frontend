---
export const prerender = false;

import Layout from '../../../../layouts/Layout.astro';
import { getProjects, getProjectById } from '../../../../lib/api';
import i18n from '../../../../i18n/i18n';

import ExternalLinksSection from '@/components/projectDetail/ExternalLinksSection.astro';
import ContentSection from '@/components/projectDetail/ContentSection.astro';
import HeroSection from '@/components/projectDetail/HeroSection.astro';
import ContributorSection from '@/components/projectDetail/ContributorSection.astro';
import CertifySection from '@/components/projectDetail/CertifySection.astro';
import CommentSection from '@/components/projectDetail/CommentSection.astro';
import RelatedProjectSection from '@/components/projectDetail/RelatedProjectSection.astro';
import HeaderBar from '@/components/common/header/HeaderBar.astro';

// Default context - will be updated client-side
const userContext = {
  username: null,
  name: null,
  avatar: null,
  isAuthenticated: false,
  isProfessor: false,
  userLiked: false,
};

// generate paths
export async function getStaticPaths() {
  const projects = await getProjects();
  const languages = ['en', 'th'];
  const paths = projects.data.flatMap((p) => {
    return languages.map((lang) => {
      return {
        params: {
          lang,
          slug: p.projectId,
        },
      };
    });
  });
  return paths;
}

// load params and project
const { slug: projectId, lang } = Astro.params as {
  slug: string;
  lang: string;
};
const currentLang = lang === 'th' ? 'th' : 'en';
i18n.changeLanguage(currentLang);
const t = i18n.t.bind(i18n);

const project = await getProjectById(projectId);
if (!project) {
  return Astro.redirect(`/${currentLang}/404`, 302);
}
---

<Layout title={project.title}>
  <HeaderBar t={t} lang={lang} />
  <HeroSection t={t} lang={lang} project={project} userContext={userContext}/>
  <ContentSection t={t} lang={lang} project={project} />
  <ExternalLinksSection t={t} lang={lang} project={project} />
  <ContributorSection t={t} lang={lang} project={project} />
  <!-- <CertifySection t={t} lang={lang} project={project} certification={certification} userContext={userContext}/> -->
  <CommentSection t={t} lang={lang} project={project} userContext={userContext}/>
  <RelatedProjectSection t={t} lang={lang} project={project} />
</Layout>

<!-- <script>
  import { getMyProfile } from '@/lib/api';
  
  async function initUserContext() {
    try {
      const user = await getMyProfile();
      
      if (user) {
        // Update global context and UI here
        globalThis.USER_CONTEXT = {
          userId : user.uerId,
          username: user.username,
          name: user.fullname,
          avatar: user.profileImageUrl,
          role: user.role,
          isAuthenticated: true,
          isProfessor: user.role === 'professor',
          userLiked: false, // Check this separately
        };
        
        // Dispatch event for React components
        window.dispatchEvent(new CustomEvent('userContextReady', {
          detail: globalThis.USER_CONTEXT
        }));
      } else {
        console.log('‚ùå No user found or not authenticated');
      }
    } catch (error) {
      console.error('üí• Error initializing user context:', error);
    }
  }
  
  // Run when DOM is loaded
  document.addEventListener('DOMContentLoaded', initUserContext);
</script> -->