---
import { MessageCircle, CornerDownRight } from "lucide-react";
import Avatar from "../common/Avatar/Avatar";
import { ContributorActionBar } from "./ContributorActionBar";
import { formatDate } from "@/lib/dateFormat";
import CommentInputSection from "./CommentInputSection";

const { t, lang, project, token, userContext } = Astro.props;

// Decompose project
const projectId = project.projectId || '';
const contributors = project.contributors || [];
const createdAt = formatDate(project?.createdAt || 'Unknown date');
const likeCount = project?.likeCount || 0;
const files = project.files || [];
const isLiked = project.isLikedByCurrentUser || false;
console.log('CommentSection - isLiked:', isLiked);
console.log('isLike:', project.isLikedByCurrentUser);

const comments = Array.isArray(project.comments) 
  ? project.comments 
  : project.comments ? [project.comments] : [];

---

<section id="CommentProjectDetail" class="flex w-full flex-col gap-4 py-4 px-[var(--padding-xl)]">
  <div class="flex flex-col px-3 gap-3">

    <!-- Contributor and Buttons Card (remains the same) -->
    <div class="simple-card w-full! px-5 py-5">
      <ContributorActionBar
        client:load
        contributors={contributors}
        projectId={projectId}
        likeCount={likeCount}
        isLiked={isLiked}
        createdAt={createdAt}
        files={files}
        token={token}
      />
    </div>

    <!-- Display Comments Card (remains the same) -->
    <div class="simple-card w-full! px-5 py-5">
      <div class="flex items-center gap-2">
        <MessageCircle className="w-5 h-5 text-main-neutral2"/>
        <h3 class="text-main-neutral2">Comments</h3>
        {comments.length > 0 && (
          <h3 class="text-main-neutral2">({comments.length})</h3>
        )}
      </div>
      <div class="flex flex-col">
        {comments.length > 0 ? (
          comments.map((commentator: any) => (
            <div class="flex items-start px-4 py-3 gap-4">
              <Avatar
                client:load
                name={commentator.user.fullname}
                avatar={commentator.user.profileImageUrl}
                className="shrink-0"
              />
              <div class="flex flex-col py-1 gap-1 max-w-md">
                <div class="gap-1">
                  <span class="text-main-neutral2 small">{commentator.user.fullname}</span>
                  <span class="text-supporting-support detail">Â·</span>
                  <span class="text-supporting-support detail">
                    {formatDate(commentator.commentedAt)}
                  </span>
                </div>
                <div class="flex items-start gap-2">
                  <CornerDownRight className="w-3 h-3 text-main-neutral2 shrink-0"/>
                  <p class="text-main-neutral2 detail warp-break-words">
                    {commentator.message}
                  </p>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div class="text-center py-6 text-sm text-gray-500">
            No comments yet. Be the first to share your thoughts!
          </div>
        )}
      </div>  
    </div>

    <!-- Input Comment Card -->
    <div class="simple-card w-full! px-5 py-5 gap-3">
      <h3 class="text-main-neutral2">What are your thoughts?</h3>
        <CommentInputSection 
            client:load 
            projectId={projectId} 
        />
    </div>
  </div>
</section>