---
import BlockRenderer from "@/components/common/BlockNote/BlockRenderer";
import type { PartialBlock } from "@blocknote/core";

const { t, lang, project } = Astro.props;

const makeParagraph = (text: string): PartialBlock[] => [
  {
    id: crypto.randomUUID(),
    type: "paragraph",
    content: [text],
  },
];

let blocks: PartialBlock[];

try {
  const parsed = JSON.parse(project.content);

  if (Array.isArray(parsed)) {
    // เBlockNote JSON
    blocks = parsed;

  } else if (typeof parsed === "string") {
    // JSON string
    blocks = makeParagraph(parsed);

  } else {
    // JSON เป็น object ที่ใช้กับ BlockNote ไม่ได้
    blocks = makeParagraph(project.content);
  }

} catch (err) {
  console.error("Failed to parse project.content:", err);

  // ถ้าเป็น text ธรรมดาจริง ๆ → ใช้ content เดิมเลย
  if (typeof project.content === "string" && project.content.trim() !== "") {
    blocks = makeParagraph(project.content);
  } else {
    blocks = makeParagraph("The author didn't provide valid project content.");
  }
}
---

<section id="ContentProjectDetail" class="flex w-full flex-col gap-4 py-4 px-[var(--padding-xl)]">
  <div class="flex px-3">
    <div class="simple-card w-full! px-0 md:px-5 py-5">
      <BlockRenderer client:only="react" blocks={blocks} />
    </div>
  </div>
</section>
