---
// filepath: d:\KMUTT\SE\App\mhodngan-kmutt-frontend\src\components\projectDetail\CertifySection.astro
import { Award, CheckCircle, Shield } from "lucide-react";
import Avatar from "../common/Avatar/Avatar";
import { ConfirmationModal } from "../common/modal/CertifyModal";

const { t, lang, project } = Astro.props;

// Decompose project
const projectId = project.projectId || '';
const projectTitle = project.title || '';
const certifiedBy = Array.isArray(project.certifiedBy) 
  ? project.certifiedBy 
  : project.certifiedBy ? [project.certifiedBy] : [];

const isCertified = certifiedBy.length > 0;
---

<section id="CertifiedProjectDetail" class="flex w-full flex-col gap-4 py-4 px-[150px]">
    <div class="flex px-3">
        {/* Pass the list of certifying professors to the client script via a data attribute */}
        <div 
            id="certification-wrapper"
            class="simple-card w-full! px-5 py-5"
            data-certified-by={JSON.stringify(certifiedBy)}
        >
            <div class="flex items-center gap-2">
                <Award className="text-main-neutral2"/>
                <h3 class="text-main-neutral2">Certified by Professor</h3>
            </div>
            <div class="flex flex-col gap-3">
                {isCertified ? certifiedBy.map((prof : any) => (
                    <div class="flex items-center gap-3">
                        <Avatar
                            client:load
                            name={prof.fullname}
                            avatar={prof.profile_image_url}
                        />
                        <div class="flex flex-col py-1">
                            <span class="large">{prof.fullname}</span>
                            <span class="detail text-supporting-ghost">
                                {prof.position} | {prof.faculty}
                            </span>
                        </div>
                    </div>
                )) : (
                    <div id="awaiting-certification-message" class="text-center py-4">
                        <span class="text-neutral-500 italic">This project is awaiting certification</span>
                    </div>
                )}

                {/* This container holds the different actions for a professor, all hidden by default */}
                <div id="professor-action-area" class="hidden">
                    {/* State 1: Button to certify the project */}
                    <div id="certify-container" class="hidden flex flex-col items-center justify-center px-3 py-3 gap-5">
                        <Shield className="w-16 h-16 text-supporting-support" />
                        <span class="subtle">This project is pending for your certification</span>
                        <button 
                            id="certify-button"
                            class="btn-primary px-4 py-2 flex items-center justify-center gap-2"
                            data-project-id={projectId}
                            data-project-name={projectTitle}>
                            <Award className="w-5 h-5 text-white"/>
                            <span class="small text-white">Certify This Project</span>
                        </button>
                    </div>

                    {/* State 2: Badge shown after the current user has certified it */}
                    <div id="already-certified-by-user-badge" class="hidden">
                        <button 
                            class="btn-locked w-full px-2! py-2! pointer-events-none" 
                            style="background-color: var(--color-supporting-light-sky); border-color: var(--color-supporting-light-sky);">
                            <CheckCircle className="w-5 h-5 text-supporting-dark-sky"/>
                            <span class="small text-supporting-dark-sky">You have certified this project</span>
                        </button>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <ConfirmationModal
        client:load
        projectId={projectId}
        projectName={projectTitle}
        title="Project Certification Confirmation"
        warningMessage="This action cannot be undone. By certifying this project, you confirm that it meets the required academic standards."
        confirmButtonText="Certify Project"
        loadingText="Certifying..."
    />
</section>

<script>
    interface Professor {
        userId: string;
        fullname: string;
        profile_image_url: string;
        position?: string;
        faculty?: string;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const wrapper = document.getElementById('certification-wrapper');
        if (!wrapper) {
            console.error('Certification wrapper not found!');
            return;
        }

        const professorActionArea = document.getElementById('professor-action-area');
        const certifyContainer = document.getElementById('certify-container');
        const alreadyCertifiedBadge = document.getElementById('already-certified-by-user-badge');
        const awaitingMessage = document.getElementById('awaiting-certification-message');
        const certifyButton = document.getElementById('certify-button');

        try {
            const rawUserData = sessionStorage.getItem('userData');
            if (!rawUserData) return; // Not logged in, do nothing

            const userData = JSON.parse(rawUserData);
            if (userData?.role !== 'professor') return; // Not a professor, do nothing

            // User is a professor, show the action area
            if (professorActionArea) professorActionArea.classList.remove('hidden');

            if (awaitingMessage) awaitingMessage.classList.add('hidden');

            const certifiedByList: Professor[] = JSON.parse(wrapper.dataset.certifiedBy || '[]');
            const currentUserId = userData.userId;

            const hasCurrentUserCertified = certifiedByList.some(prof => prof.userId === currentUserId);

            if (hasCurrentUserCertified) {
                // This professor has already certified the project, show the badge
                if (alreadyCertifiedBadge) alreadyCertifiedBadge.classList.remove('hidden');
            } else {
                // This professor has NOT certified the project, show the button
                if (certifyContainer) certifyContainer.classList.remove('hidden');
            }

        } catch (e) {
            console.error("Error processing certification logic:", e);
        }
        
        // Add event listener for the certify button
        if (certifyButton) {
            certifyButton.addEventListener('click', () => {
                window.dispatchEvent(new CustomEvent('openCertificationModal', {
                    detail: {
                        projectId: certifyButton.getAttribute('data-project-id'),
                        projectName: certifyButton.getAttribute('data-project-name')
                    }
                }));
            });
        }
    });
</script>